{"version":3,"sources":["index.js"],"names":[],"mappings":"AAAA;;;;AACA;;AAMA;;;;;;;;IAEM;AACJ,WADI,OACJ,CAAY,UAAZ,EAAwB;0BADpB,SACoB;;AACtB,wBAAO,IAAP,EAAa,UAAb,EADsB;GAAxB;;eADI;;gCAIQ;;;;AAEV,UAAI,YAAY,EAAZ,CAFM;AAGV,UAAI,CAAC,KAAK,WAAL,EAAkB;AACrB,eAAO,SAAP,CADqB;OAAvB;AAGA,UAAI,CAAC,KAAK,WAAL,EAAkB;AACrB,aAAK,WAAL,GAAmB,MAAnB,CADqB;OAAvB;AAGA,kBAAY,UAAU,MAAV,CAAiB,KAAK,WAAL,CAAiB,oBAAjB,CAAsC,KAAK,WAAL,CAAvD,CAAZ,CATU;AAUV,UAAI,CAAC,KAAK,IAAL,IAAa,CAAC,KAAK,KAAL,EAAY;AAC7B,eAAO,SAAP,CAD6B;OAA/B;AAGA,UAAI,WAAW,kBAAK,KAAK,KAAL,EAAY,UAAC,IAAD,EAAU;AACxC,eAAO,KAAK,GAAL,KAAa,MAAK,IAAL,CAAU,KAAV,CAAgB,QAAhB,IAA4B,KAAK,WAAL,KAAqB,MAAK,WAAL,CAD7B;OAAV,CAA5B,CAbM;AAgBV,UAAI,QAAJ,EAAc;AACZ,oBAAY,UAAU,MAAV,CAAiB,SAAS,MAAT,CAA7B,CADY;OAAd;AAGA,UAAI,CAAC,KAAK,MAAL,EAAa;AAChB,eAAO,SAAP,CADgB;OAAlB;AAGA,UAAI,iBAAiB,kBAAK,KAAK,IAAL,CAAU,KAAV,CAAgB,WAAhB,EAA6B,UAAC,eAAD,EAAqB;AAC1E,eAAO,gBAAgB,MAAhB,KAA2B,MAAK,MAAL,CAAY,GAAZ,CADwC;OAArB,CAAnD,CAtBM;AAyBV,UAAI,cAAJ,EAAoB;AAClB,YAAI,aAAa,kBAAK,KAAK,KAAL,EAAY,UAAC,IAAD,EAAU;AAC1C,iBAAO,KAAK,GAAL,KAAa,eAAe,IAAf,IAAuB,KAAK,WAAL,KAAqB,MAAK,WAAL,CADtB;SAAV,CAA9B,CADc;AAIlB,YAAI,UAAJ,EAAgB;AACd,sBAAY,UAAU,MAAV,CAAiB,WAAW,MAAX,CAA7B,CADc;SAAhB;OAJF;AAQA,aAAO,SAAP,CAjCU;;;;6BAmCH,OAAO;;;AACd,aAAO,QAAQ,OAAR,GAAkB,IAAlB,CAAuB,YAAM;AAClC,YAAI,CAAC,KAAD,IAAU,CAAC,MAAM,GAAN,EAAW;AACxB,iBAAO,KAAP,CADwB;SAA1B;AAGA,eAAO,kBAAK,OAAK,SAAL,EAAL,EAAuB,UAAC,GAAD,EAAS;AACrC,iBAAO,QAAQ,MAAM,GAAN,CADsB;SAAT,CAA9B,CAJkC;OAAN,CAA9B,CADc;;;;SAvCZ;;;AAkDN,IAAI,QAAJ;AACA,QAAQ,GAAR,GAAc,UAAU,OAAV,EAAmB,QAAnB,EAA6B;AACzC,aAAW,OAAX,CADyC;AAEzC,SAAO,mBAAS,OAAT,CAAiB,QAAjB,EACJ,OADI,CACI,QADJ,CAAP,CAFyC;CAA7B;AAKd,QAAQ,OAAR,GAAkB,YAAY;AAC5B,SAAO,QAAP,CAD4B;CAAZ;;AAIlB,QAAQ,GAAR,GAAc,UAAU,QAAV,EAAoB;AAChC,SAAO,mBAAS,GAAT,CAAa,YAAY;AAC9B,QAAI,CAAC,QAAD,EAAW;AACb,iBAAW,IAAI,OAAJ,CAAY,EAAZ,CAAX,CADa;KAAf;AAGA,WAAO,QAAP,CAJ8B;GAAZ,CAAb,CAKJ,OALI,CAKI,QALJ,CAAP,CADgC;CAApB;;AASd,QAAQ,MAAR,GAAiB,QAAQ,UAAR,CAAjB;;AAEA,OAAO,OAAP,GAAiB,OAAjB","file":"index.js","sourcesContent":["'use strict';\nimport {\n  extend,\n  find,\n  some\n}\nfrom 'lodash';\nimport Bluebird from 'bluebird';\n\nclass Context {\n  constructor(properties) {\n    extend(this, properties);\n  }\n  getClaims() {\n    /* returns claims against anon, user, and bucket role */\n    var claimList = [];\n    if (!this.application) {\n      return claimList;\n    }\n    if (!this.environment) {\n      this.environment = 'live';\n    }\n    claimList = claimList.concat(this.application.anonymousPermissions[this.environment]);\n    if (!this.user || !this.roles) {\n      return claimList;\n    }\n    var userRole = find(this.roles, (role) => {\n      return role._id === this.user.roles.mainRole && role.environment === this.environment;\n    });\n    if (userRole) {\n      claimList = claimList.concat(userRole.claims);\n    }\n    if (!this.bucket) {\n      return claimList;\n    }\n    var userBucketRole = find(this.user.roles.bucketRoles, (innerBucketRole) => {\n      return innerBucketRole.bucket === this.bucket._id;\n    });\n    if (userBucketRole) {\n      var bucketRole = find(this.roles, (role) => {\n        return role._id === userBucketRole.role && role.environment === this.environment;\n      });\n      if (bucketRole) {\n        claimList = claimList.concat(bucketRole.claims);\n      }\n    }\n    return claimList;\n  }\n  hasClaim(claim) {\n    return Promise.resolve().then(() => {\n      if (!claim || !claim.key) {\n        return false;\n      }\n      return some(this.getClaims(), (key) => {\n        return key === claim.key;\n      });\n    });\n  }\n}\nvar _context;\nContext.set = function (context, callback) {\n  _context = context;\n  return Bluebird.resolve(_context)\n    .nodeify(callback);\n};\nContext.current = function () {\n  return _context;\n};\n\nContext.get = function (callback) {\n  return Bluebird.try(function () {\n    if (!_context) {\n      _context = new Context({});\n    }\n    return _context;\n  }).nodeify(callback);\n};\n\nContext.claims = require('./claims');\n\nmodule.exports = Context;\n"],"sourceRoot":"/source/"}